## Generated by config-gen DO NOT EDIT
input:
  label: "ingest_server_input"
  http_server:
      address: 0.0.0.0:9443
      path: /integration/{connection_id}/store
      allowed_verbs:
        - POST
      timeout: 5s
      rate_limit: "connection_rate_limit"
      tls:
        enabled: true
        client_root_cas_file: /etc/ssl/certs/dis/root_ca.crt
        server_certs:
          - cert_file: /etc/ssl/certs/dis/tls.crt
            key_file: /etc/ssl/certs/dis/tls.key
        require_mutual_tls: true
      sync_response:
        status: "200"
        headers:
          Content-Type: application/octet-stream
pipeline:
  processors:
    - label: "cloudevent_switch"
      switch:
          {{- range .Connections }}
          - check: '@http_server_request_path == "/integration/{{ .ConnectionID }}/store"'
            processors:
              - label: convert_cloudevent_{{ toLower .ConnectionName }}
                dimo_cloudevent_convert:
                  module_name: {{ .ModuleName }}
                  module_config: {{ base64 .ModuleConfig }}
          {{- end }}
    - catch:
        - label: "convert_cloudevent_errors"
          log:
            level: WARN
            message: "failed to convert to cloudevent: ${!error()}"
            fields_mapping: |
               source = "@http_server_request_path"
        - mapping: root = deleted()
output:
  label: "all_output_broker"
  broker:
    pattern: fan_out
    outputs:
      - label: "clickhouse_signal_drop_on_error"
        drop_on:
          error: true
          output:
            label: "clickhouse_signal_insert_file"
            switch:
              cases:
                  {{- range .Connections }}
                  - check: '@http_server_request_path == "/integration/{{ .ConnectionID }}/store"'
                    output:
                      label: "clickhouse_signal_insert_{{ toLower .ConnectionName }}"
                      sql_insert:
                        driver: clickhouse
                        dsn: clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/${CLICKHOUSE_DATABASE}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&secure=true&dial_timeout=200ms&max_execution_time=300
                        table: signal
                        columns: []
                        args_mapping: root = this
                        batching:
                          count: 10000
                          byte_size: 0
                          period: "200ms"
                          check: ""
                  {{- end }}
            processors:
              - label: convert_signals_switch
                switch:
                  {{- range .Connections }}
                  - check: '@http_server_request_path == "/integration/{{ .ConnectionID }}/store"'
                    processors:
                      - label: convert_signals_{{ toLower .ConnectionName }}
                        dimo_signal_convert:
                          module_name: {{ .ModuleName }}
                          module_config: {{ base64 .ModuleConfig }}
                  {{- end }}
              - catch:
                  - label: "log_convert_errors"
                    log:
                      level: WARN
                      message: "status processing failed: ${!error()}"
                      fields_mapping: |
                        vehicleTokenId = this.tokenId.or(-1)
                        source = this.source.or("unknown")
                  - mapping: root = deleted()      
      - label: "object_output_drop_on_error"
        drop_on:
          error: true
          output:
            label: "s3_object_insert"
            switch:
              cases:
                  {{- range .Connections }}
                  - check: '@http_server_request_path == "/integration/{{ .ConnectionID }}/store"'
                    output:
                      file:
                        path: '/tmp/s3_{{ toLower .ConnectionName }}${! counter(min: 1, max: 100) }.json'
                        codec: all-bytes
                  {{- end }}
            processors:
              - label: "s3_file_mapping"
                mapping: |
                  root.msg = this
                  root.metadata = metadata()