## Generated by config-gen DO NOT EDIT
input:
  label: "ingest_server_input"
  http_server:
      address: 0.0.0.0:9443
      path: /integration/{connection_id}/store
      allowed_verbs:
        - POST
      timeout: 5s
      rate_limit: "connection_rate_limit"
      tls:
        enabled: true
        client_root_cas_file: /etc/ssl/certs/dis/root_ca.crt
        server_certs:
          - cert_file: /etc/ssl/certs/dis/tls.crt
            key_file: /etc/ssl/certs/dis/tls.key
        require_mutual_tls: true
      sync_response:
        status: "200"
        headers:
          Content-Type: application/octet-stream
pipeline:
  processors:
    - label: "cloudevent_switch"
      switch:
          - check: '@dimo_http_server_connection_id == "0x3A6603E1065C9b3142403b1b7e349a6Ae936E819"'
            processors:
              - label: convert_cloudevent_ruptela
                dimo_cloudevent_convert:
                  module_name: ruptela
                  module_config: ewogICJjaGFpbl9pZCI6ICIxMzciLAogICJhZnRlcm1hcmtldF9jb250cmFjdF9hZGRyIjogIjB4OWM5NEMzOTVjQmNCRGU2NjIyMzVFMEE5ZDNiQjg3QWQ3MDg1NjFCQSIsCiAgInZlaGljbGVfY29udHJhY3RfYWRkciI6ICIweGJBNTczOGExOGQ4M0Q0MTg0N2RmRmJEQzYxMDFkMzdDNjljOUIwY0YiCn0K
          - check: '@dimo_http_server_connection_id == "macaron_integration_id"'
            processors:
              - label: convert_cloudevent_macaron
                dimo_cloudevent_convert:
                  module_name: macaron
                  module_config: ewogICJkZXZpY2VfYXBpX3VybCI6ICJodHRwOi8vZGV2aWNlcy1hcGktZGV2OjgwODYiCn0K
    - catch:
        - label: "convert_cloudevent_errors"
          log:
            level: WARN
            message: "failed to convert to cloudevent: ${!error()}"
            fields_mapping: |
               source = "@http_server_request_path"
        - mapping: root = deleted()
output:
  label: "all_output_broker"
  broker:
    pattern: fan_out
    outputs:
      - label: "clickhouse_signal_drop_on_error"
        drop_on:
          error: true
          output:
            label: "clickhouse_signal_insert_file"
            switch:
              cases:
                  - check: '@dimo_http_server_connection_id == "0x3A6603E1065C9b3142403b1b7e349a6Ae936E819"'
                    output:
                      label: "clickhouse_signal_insert_ruptela"
                      sql_insert:
                        driver: clickhouse
                        dsn: clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/${CLICKHOUSE_SIGNAL_DATABASE}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&secure=true&dial_timeout=200ms&max_execution_time=300
                        table: signal
                        columns: []
                        args_mapping: root = this
                        batching:
                          count: 10000
                          byte_size: 0
                          period: "200ms"
                          check: ""
                  - check: '@dimo_http_server_connection_id == "macaron_integration_id"'
                    output:
                      label: "clickhouse_signal_insert_macaron"
                      sql_insert:
                        driver: clickhouse
                        dsn: clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/${CLICKHOUSE_SIGNAL_DATABASE}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&secure=true&dial_timeout=200ms&max_execution_time=300
                        table: signal
                        columns: []
                        args_mapping: root = this
                        batching:
                          count: 10000
                          byte_size: 0
                          period: "200ms"
                          check: ""
            processors:
              - label: signal_db_migration
                dimo_signal_migration:
                  dsn: clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/${CLICKHOUSE_SIGNAL_DATABASE}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&secure=true&dial_timeout=5s&max_execution_time=300
              - label: convert_signals_switch
                switch:
                  - check: '@dimo_http_server_connection_id == "0x3A6603E1065C9b3142403b1b7e349a6Ae936E819"'
                    processors:
                      - label: convert_signals_ruptela
                        dimo_signal_convert:
                          module_name: ruptela
                          module_config: ewogICJjaGFpbl9pZCI6ICIxMzciLAogICJhZnRlcm1hcmtldF9jb250cmFjdF9hZGRyIjogIjB4OWM5NEMzOTVjQmNCRGU2NjIyMzVFMEE5ZDNiQjg3QWQ3MDg1NjFCQSIsCiAgInZlaGljbGVfY29udHJhY3RfYWRkciI6ICIweGJBNTczOGExOGQ4M0Q0MTg0N2RmRmJEQzYxMDFkMzdDNjljOUIwY0YiCn0K
                  - check: '@dimo_http_server_connection_id == "macaron_integration_id"'
                    processors:
                      - label: convert_signals_macaron
                        dimo_signal_convert:
                          module_name: macaron
                          module_config: ewogICJkZXZpY2VfYXBpX3VybCI6ICJodHRwOi8vZGV2aWNlcy1hcGktZGV2OjgwODYiCn0K
              - catch:
                  - label: "log_convert_errors"
                    log:
                      level: WARN
                      message: "status processing failed: ${!error()}"
                      fields_mapping: |
                        vehicleTokenId = this.tokenId.or(-1)
                        source = this.source.or("unknown")
                  - mapping: root = deleted()      
      - label: "object_output_drop_on_error"
        drop_on:
          error: true
          output:
            label: "object_output"
            broker:
              outputs:
                - label: "s3_cloudevent_insert"
                  switch:
                    cases:
                        - check: '@dimo_cloudevent_index_type == "full"'
                          output:
                            label: "s3_status_cloudevent_insert"
                            aws_s3:
                              bucket: ${S3_CLOUDEVENT_BUCKET}
                              path: ${!meta("dimo_cloudevent_index")}
                              content_type: application/json
                              region: us-east-2
                              max_in_flight: 250
                              timeout: 30s
                              credentials:
                                id: ${S3_AWS_ACCESS_KEY_ID}
                                secret: ${S3_AWS_SECRET_ACCESS_KEY}
                        - check: ''
                          output:
                            label: "s3_tmp_cloudevent_insert"
                            aws_s3:
                              bucket: ${S3_CLOUDEVENT_TMP_BUCKET}
                              path: ${!meta("dimo_cloudevent_index")}
                              content_type: application/json
                              region: us-east-2
                              max_in_flight: 250
                              timeout: 30s
                              credentials:
                                id: ${S3_AWS_ACCESS_KEY_ID}
                                secret: ${S3_AWS_SECRET_ACCESS_KEY}
                - label: "clickhouse_cloudevent_index_insert"
                  sql_insert:
                    driver: clickhouse
                    dsn: clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/${CLICKHOUSE_INDEX_DATABASE}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&secure=true&dial_timeout=5s&max_execution_time=300
                    table: name_index
                    columns: []
                    args_mapping: root = metadata("dimo_cloudevent_index_values")
                    batching:
                      count: 10000
                      byte_size: 0
                      period: "200ms"
                      check: ""
            processors:
              - label: "file_index_db_migration"
                dimo_file_index_migration:
                  dsn: clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}/${CLICKHOUSE_INDEX_DATABASE}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&secure=true&dial_timeout=5s&max_execution_time=300
              - label: "create_cloudevent_index"
                dimo_cloudevent_index: {}